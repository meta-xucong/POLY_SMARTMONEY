# 数据整合蓝图：候选账号筛选与可跟单画像生成

> 目标：新建一个独立的 `screen_users.py`，读取当前脚本落盘的 CSV 数据，自动生成“候选账号筛选表 + 全量特征表”，用于挑选**高胜率、低频、额度适中、可跟单**的账号。

---

## 一、输入/输出约定

### 输入数据（不改采集脚本）
路径约定：`data/users/<address>/` 目录内

- `closed_positions.csv`：窗口内平仓记录（每条平仓一行）
  - 关键字段：`avg_price`, `total_bought`, `realized_pnl`, `timestamp`, `condition_id`, `slug`, `title`, `outcome`
- `positions.csv`：当前未平仓持仓快照（每条持仓一行）
  - 关键字段：`size`, `initial_value`, `current_value`, `cash_pnl`, `realized_pnl`, `end_date`, `condition_id`, `slug`, `title`
- `users_summary.csv`（可选）：每用户汇总表
  - 关键字段：`win_rate_no_flat`, `win_count`, `loss_count`, `flat_count`, `closed_count`, `open_count`, `open_mtm_pnl_sum`, `total_mtm_pnl`

### 输出数据（建议两张表）
- `users_features.csv`：全量用户特征表（便于调参、回溯）
- `candidates.csv`：硬过滤 + 排名后候选表

---

## 二、核心目标与指标维度

核心目标：筛选出**胜率高但不靠高频套利**、**单笔规模不过大**、**风险敞口可控**、**具备可复制性**的账户。

### 维度 A：胜率可信度（高胜率 + 样本量）
**取数来源**：`users_summary.csv` 或 `closed_positions.csv`

**指标**：
- `closed_count`（样本量）
- `win_rate_no_flat`
- **收缩胜率**（建议）：`(win + α) / (win + loss + α + β)`

**用途**：过滤“样本太少”的高胜率账号。

---

### 维度 B：交易节奏（排除高频时间敏感）
**取数来源**：`closed_positions.csv.timestamp`

**指标**：
- `trades_per_day = closed_count / window_days`
- `max_trades_per_day`、`p95_trades_per_day`
- **爆发度**：`max_daily / mean_daily`
- **交易间隔分布**：相邻 `timestamp` 间隔的 P10 / median

**用途**：剔除分钟级密集交易/高频套利。

---

### 维度 C：单笔规模与极端风险
**取数来源**：`closed_positions.csv.avg_price`, `total_bought`, `realized_pnl`

**指标**：
- 单笔名义成本：`cost ≈ avg_price * total_bought`
- `median_cost`, `p90_cost`, `max_cost`
- `median_pnl`, `max_loss`, `p95_loss`

**用途**：排除单笔过大或尾部风险过高的账号。

---

### 维度 D：薄利高胜率套利识别
**取数来源**：`realized_pnl` + `cost`

**指标**：
- `roi = realized_pnl / cost`
- `median_roi`, `mean_roi`
- `profit_factor = sum(win_pnl) / abs(sum(loss_pnl))`
- 套利特征：**高胜率 + 低 ROI + 高频**

**用途**：避免“胜率高但跟单无意义”的账号。

---

### 维度 E：当前风险敞口与可跟单性
**取数来源**：`positions.csv.current_value`, `open_count`, `end_date`

**指标**：
- `open_exposure = sum(current_value)`
- `open_count`
- 集中度：`top1_current_value / sum(current_value)`
- 临近到期占比：`end_date - asof_time < X 天` 的仓位占比

**用途**：过滤当前敞口过大或极端短期策略账号。

---

## 三、程序结构与实现思路（不写代码，只给方法）

### 1）入口脚本结构
新建 `screen_users.py`，按模块化流程组织：

1. **加载配置**
   - 数据根目录（`data/users/`）
   - 时间窗口（用于频率与统计口径）
   - 过滤阈值（最小样本量、最大频率等）
   - 输出路径

2. **遍历用户目录**
   - 读取 `closed_positions.csv` / `positions.csv` / 可选 `users_summary.csv`
   - 若缺失关键文件，记录跳过原因

3. **特征计算**（见“核心指标维度”）
   - 基于 `closed_positions.csv` 生成交易频率、单笔规模、ROI、收益分布
   - 基于 `positions.csv` 生成当前敞口、集中度、到期结构
   - 汇总到“用户级特征字典”

4. **硬过滤 + 排名**
   - 先用阈值进行硬过滤（样本量、频率、单笔规模、最大亏损、当前敞口）
   - 对通过者计算 `CopyScore`（可调权重）并排序

5. **落盘输出**
   - 输出 `users_features.csv`
   - 输出 `candidates.csv`
   - 同时写入 `metadata.json`：包含时间窗口、阈值、运行时间

---

## 四、CopyScore 评分建议（可解释 + 可调权重）

建议公式（示意）：

```
CopyScore =
  + w1 * bayes_win_rate
  + w2 * profit_factor
  + w3 * median_roi
  - w4 * trades_per_day
  - w5 * burstiness
  - w6 * p90_cost
  - w7 * open_exposure
  - w8 * near_expiry_ratio
```

- **正向项**：收缩胜率、盈利因子、单笔 ROI
- **惩罚项**：频率、爆发度、单笔规模、当前敞口、临近到期比例

> 输出 `CopyScore` 的同时，也应保留每个分项数值，方便解释“为何入选”。

---

## 五、阈值模板（默认值示意）

- `closed_count >= 20`
- `trades_per_day <= 10`
- `max_trades_per_day <= 30`
- `p90_cost <= 2000`（按实际资金口径调整）
- `max_loss >= -1000`
- `open_exposure <= 5000`

> 这些阈值应该最终按你实际资金规模与跟单能力调整。

---

## 六、数据处理注意事项

- `timestamp/end_date` 要统一解析为 `datetime`
- `cost = avg_price * total_bought` 时需处理空值与 0
- `roi` 在 `cost` 极小值时容易异常，建议设置 `min_cost`（如 `cost < 1` 视为噪声）
- 出现 NaN 时保留字段但不用于评分

---

## 七、最终产出效果

1. **users_features.csv**（全量特征）
   - 便于阈值调参、可解释分析
2. **candidates.csv**（候选表）
   - 排序后直接作为“跟单白名单”
   - 含 CopyScore 与关键指标

---

## 八、你最终得到什么

- 一个可复用的筛选脚本 `screen_users.py`
- 统一、可解释、可调参的“跟单候选名单表”
- 不需要改采集脚本，全部基于现有 CSV 直接加工
