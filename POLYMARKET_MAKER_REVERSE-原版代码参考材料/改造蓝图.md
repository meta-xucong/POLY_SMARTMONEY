# POLYMARKET_MAKER_REVERSE 改造蓝图

## 背景与目标
- 在不改变框架结构的前提下，将原版 `POLYMARKET_MAKER_AUTO` 的“价格区间”筛选替换为“价格反转检测”。
- 保留现有粗筛、高亮相关的逻辑（黑名单、成交量阈值、剩余时间 ≤ t1 等），并继续复用自动化调度、并发控制与挂单策略代码。
- 采用“两段式触发”的价格反转检测，降低 `/prices-history` 查询负载。

## 现状速览（参考）
- 入口：`poly_maker_reverse.py` 调用 `Customize_fliter_reverse.py` 生成候选，再按配置启动 `POLYMARKET_MAKER/Volatility_arbitrage_run.py` 等脚本。
- 配置：`POLYMARKET_MAKER/config/global_config_reverse.json` 决定调度频率；`filter_params_reverse.json` 定义筛选/高亮阈值；`strategy_defaults_reverse.json` 提供挂单策略模板。
- 筛选：`Customize_fliter_reverse.py` 负责 Gamma 拉市场、早筛、回补订单簿与高亮判定，目前含 ask 区间等价格口径。

## 改造范围与定位
- **仅修改** `Customize_fliter_reverse.py` 的筛选与高亮相关逻辑，新增价格反转检测所需的参数、计算与输出。
- 若需要新增默认值/参数暴露，可更新 `POLYMARKET_MAKER/config/filter_params_reverse.json` 与 README 说明；其余框架文件保持不动。
- 所有改造结果放入新目录 `POLYMARKET_MAKER_REVERSE`（现仓库路径即为目标目录）。

## 参数与规则设计
- 继续沿用原有粗筛参数：
  - 黑名单关键词（title/slug/tags）。
  - 成交量/流动性阈值（如 totalVolume、volume24h）。
  - 结束时间窗口：距离结束时间 ≤ t1（默认 48h），保持原实现。
  - 仅保留二元市场且具备 `clobTokenIds`。
- 替换价格区间为价格反转检测：
  - 参考默认值：`p1=0.35`（过去一段时间的最高价上限）、`p2=0.8`（近 t2 小时内的冲高阈值）、`t2=2h`（近期窗口）。
  - 旧段窗口：`now - 5d` 至 `now - t2`；近段窗口：`now - t2` 至 `now`。
  - 判定：`max(旧段价格) < p1` 且 `max(近段价格) >= p2` 即认定为反转。

## 两段式触发实现步骤
1. **短窗口预筛**（降低请求量）
   - 对粗筛后的每个 token（可默认 YES 方向）：调用 `/prices-history`，参数示例：`interval=6h` 或 `1d`，`fidelity=5~15` 分钟。
   - 仅判断近 `t2` 小时内 `max(price)` 是否达到 `p2`。若未达标，跳过长窗口。
2. **长窗口确认**（仅对触发者）
   - 再次调用 `/prices-history`，`startTs = now - 5d`，`endTs = now`，`fidelity=60`（或 15 以防漏点）。
   - 切分旧段/近段，验证 `max(旧段) < p1` 与 `max(近段) >= p2`。
3. **结果记录**
   - 将通过反转检测的 token 标记到高亮信息或候选列表，供自动挂单使用。
   - 保留原有诊断/打印格式（流式或汇总）以便排查。

## 代码改造拆解
- **参数层**：
  - 为 CLI 与配置文件新增 `--rev-p1 / --rev-p2 / --rev-window-hours`（对应 p1、p2、t2）、`--rev-lookback-days`（旧段回溯天数，默认 5），并提供默认值；保持与 `filter_params_reverse.json` 的映射。
  - 若需关闭反转检测，可提供开关（如 `--enable-reversal`）。
- **数据抓取层**：
  - 在早筛后、订单簿补全前插入价格历史获取逻辑。
  - 新增请求封装函数：`fetch_prices_history(token_id, *, start_ts=None, end_ts=None, interval=None, fidelity=60)`，支持异常兜底与最小重试。
  - 注意按 token 粒度调用，避免对 market 层重复请求。
- **判定逻辑层**：
  - 实现“两段式触发”函数：`detect_reversal(token_id, *, p1, p2, t2_hours, lookback_days)`，内部调用短窗口→长窗口。
  - 对返回的反转结果写入 `MarketSnapshot` 或附加字段（如 `market.reversal_hit = True`，`market.reversal_detail = {...}`）。
  - 将原价区间的高亮替换为 `reversal_hit` 触发的高亮/候选选中逻辑；保留其它高亮条件（点差、volume 等）。
- **输出与集成层**：
  - 在筛选日志与流式输出中增加反转状态显示（如“REV✔/✘”及触发阈值）。
  - 维持 `FilterResult.chosen/highlights` 的结构，确保 `poly_maker_reverse.py` 能无缝读取并启动交易。
  - 若高亮只基于反转结果，需要同步更新提示文本/表头说明。

## 测试与验证计划
- **单元/脚本级自测**：
- 本地运行 `python Customize_fliter_reverse.py --stream --hl-max-hours 48`，观察反转标记输出，确认不再依赖 ask 区间。
  - 使用 mock 或小范围市场（可指定 `--market-id` 之类的过滤参数若已有）验证短窗口触发与长窗口确认的分支。
- **集成验证**：
  - 运行 `poly_maker_reverse.py --no-repl --command "list"`，确保筛选结果写入 `POLYMARKET_MAKER/logs/topics_filtered.json`，挂单任务按预期启动。
  - 检查调度频率与 `global_config_reverse.json` 一致，且新增参数能在 `filter_params_reverse.json` 覆盖。

## 交付物
- 更新后的 `Customize_fliter_reverse.py`、必要的配置文件以及 README 补充说明全部位于 `POLYMARKET_MAKER_REVERSE` 目录内。
- 本蓝图作为改造指导文档，后续按步骤实施并提交代码与配置调整。
